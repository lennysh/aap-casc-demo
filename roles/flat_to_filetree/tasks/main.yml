---
# tasks file for flat_to_filetree

- name: ğŸš§ Validate input variables
  ansible.builtin.assert:
    that:
      - flat_to_filetree_source_path is defined and flat_to_filetree_source_path | length > 0
      - flat_to_filetree_output_path is defined and flat_to_filetree_output_path | length > 0
    fail_msg: "Please define 'flat_to_filetree_source_path' and/or 'flat_to_filetree_output_path'"

- name: ğŸ” Find all var files
  ansible.builtin.find:
    paths: "{{ flat_to_filetree_source_path }}"
    recurse: true
    patterns:
      - '*.yml'
      - '*.yaml'
  register: found_var_files

- name: Initialize empty var dictionary
  ansible.builtin.set_fact:
    loaded_vars_combined: {}

- name: Read and parse var files without templating
  ansible.builtin.set_fact:
    loaded_vars_combined: "{{ loaded_vars_combined | combine(parsed_content) }}"
  vars:
    # 1. Read the raw text using the 'cat' pipe (to avoid templating)
    raw_content: "{{ lookup('pipe', 'cat ' + item) }}"
    # 2. Pre-process the text to remove '!unsafe' which breaks from_yaml
    clean_content: "{{ raw_content | replace('!unsafe', '') }}"
    # 3. Parse the clean text with from_yaml.
    parsed_content: "{{ clean_content | from_yaml }}"
  loop: "{{ found_var_files.files | map(attribute='path') | list }}"
  loop_control:
    loop_var: item
  when: found_var_files.files | length > 0

- name: ğŸ”€ Iterate over the var-to-folder map to split
  ansible.builtin.include_tasks: split_var_list.yml
  loop: "{{ flat_to_filetree_var_to_folder_map | dict2items }}"
  loop_control:
    loop_var: map_item
...
